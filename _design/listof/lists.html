<html>
  <head>
<title>mailing list lists</title>
<script src="freud.js"></script>
<script src="collections-backport.js"></script>
<style>
body {
  font-family: mono;
}
.label {
  background-color: #aaa;
  color: white;
  font-size: 60%;
}
.highlight {
  background-color: yellow;
}
</style>
</head>
<body>
<h1>list of lists</h1>
<script>
var ego = new SuperEgo();

var people = new Subcollection(ego, function(x) { return x.type === "person"; });
// person: `name', `email', (also is `_id'), `parent', &c

var esearch = new iui.CollectionSearch(people);

function entry(label, onreturn, value, autocomplete) {
    var $div = document.createElement("div");
    var $lab = document.createElement("span");
    var $completions = document.createElement("div");
    var matches = [];
    var $match = null;
    var match_idx = -1;
    $completions.className = "completions";
    $lab.className = "label";
    $lab.innerHTML = label;
    $div.appendChild($lab);
    var $input = document.createElement("input");
    $input.value = value || "";

    var highlight = function() {
	if($match) {
	    $match.className = "";
	}
	if(match_idx >= 0) {
	    $match = $completions.children[match_idx];
	    $match.className = "highlight";
	    $input.value = matches[match_idx].str;
	}
    }

    $input.onkeydown = function(ev) {
	if(ev.keyCode == 13) {	// Enter
	    ev.preventDefault();
	    onreturn(this.value);
	}
	else if(ev.keyCode == 40) { // Down
	    match_idx = Math.min(matches.length-1, match_idx + 1);
	}
	else if(ev.keyCode == 38) { // Up
	    match_idx = Math.max(0, match_idx - 1);
	}
	else {
	    match_idx = -1;
	}
	highlight();
    }
    if(autocomplete != undefined) {
	$input.oninput = function(ev) {
	    matches = autocomplete.matches(this.value);
        matches = dedup(matches, function(x) { return x.str; })
	    $completions.innerHTML = "";
	    matches.forEach(function(matchobj) {
		var $div = document.createElement("div");
		$div.innerHTML = matchobj.str;
		$div.onclick = function() {
		    $input.value = matchobj.str;
		    $input.focus();
		}
		$completions.appendChild($div);
	    });
	}
    }
    $div.appendChild($input);
    $div.appendChild($completions);
    return $div;
}

var $email = entry("email", function(address) {
    if(address.indexOf("@") < 0 || address.indexOf(".") < 0) {
        alert("invalid e-mail address");
        return;
    }
    var person = new SuperModel(ego, {_id: address,
                                      type: "person",
                                      // XXX: parent: me
                                      email: address});
    person.save();
    // XXX: add more fields
}, "", esearch);

document.body.appendChild($email);

ego.track();

function dedup(list, keyfn) {
    var dd = {};               // key -> obj
    list.forEach(function(obj) {
        dd[keyfn(obj)] = obj;
    });
    var out = [];
    for(var key in dd) {
        out.push(dd[key]);
    }
    return out;
}
</script>
</body>
</html>
